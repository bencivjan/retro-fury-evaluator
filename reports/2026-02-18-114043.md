# Retro Fury Evaluation Report

**Date**: 2026-02-18
**Submission**: 20260218-111051
**Verdict**: REJECTED
**Score**: 99% (218/219 checks passed) — **1 critical failure**
**Pipeline**: evaluator.dot (Orchestrator -> Builder -> QA -> Visionary)

## Summary

The submission passes 218 of 219 automated checks (99%). All dimensions are fully implemented: raycasting engine, 5 levels, 5 weapons, 5 enemies, AI state machine, multiplayer gun game, server-authoritative networking, UI/audio, and code quality. However, **one critical multiplayer bug** causes the game to appear frozen when both players ready up, blocking the high-level goal of seamless cross-machine multiplayer.

## Automated Check Results

| Tool | Pass | Fail | Notes |
|------|------|------|-------|
| validate-structure | 57 | 0 | All expected files and modules present |
| check-syntax | 63 | 0 | All JS files parse without errors |
| verify-mechanics | 42 | 0 | Weapons, enemies, levels, AI all match spec |
| verify-rendering | 22 | 0 | Raycasting, sprites, textures, resolution correct |
| verify-multiplayer | 29 | 1 | **`mp_pointer_lock_game_start`: CRITICAL FAIL** |
| test-server | 5 | 0 | Server starts and accepts WebSocket connections |

## Critical Failure: Pointer Lock in WebSocket Handler

**Check**: `mp_pointer_lock_game_start`
**Status**: FAIL (critical)
**Location**: `src/main.js:1230-1232` (inside `onMultiplayerGameStart`)

### The Bug

When both players ready up and the server sends `game_start`, the client calls `onMultiplayerGameStart(msg)` from the WebSocket message handler. Inside this function (line 1230):

```js
if (displayCanvas && !input.isPointerLocked()) {
    displayCanvas.requestPointerLock();
}
```

**`requestPointerLock()` requires a trusted user gesture** (click, keypress) in all modern browsers. Since this call originates from a WebSocket `onmessage` event — not a user gesture — the browser silently rejects it. The result:

- The game transitions to `MP_PLAYING` and renders the arena correctly
- **Mouse input is completely dead**: `InputManager._onMouseMove` returns early when `!this._pointerLocked`
- Players cannot look around, aim, or shoot
- The game appears **frozen** to both players simultaneously
- WASD keyboard movement still works technically, but players don't know to try it
- There is no visual prompt telling players to click to acquire pointer lock

### Why Previous Evaluation Missed It

The previous evaluation tools only performed static code analysis — checking that patterns like `requestPointerLock`, `interpolation`, and `configurable host` existed in the source. They did not analyze the **calling context** of `requestPointerLock()` to detect that it's invoked from a non-user-gesture handler. This is a runtime behavior bug that requires understanding browser security policies, not just code structure.

## Vision Alignment

### Cross-Machine Multiplayer (High-Level Goal)

| Requirement | Status | Evidence |
|-------------|--------|----------|
| Server binds to all interfaces | PASS | `httpServer.listen(PORT)` |
| Configurable server host | PASS | `ws://${window.location.hostname}:3000` |
| Position interpolation | PASS | `RemotePlayer` with LERP_SPEED=15.0 |
| Disconnect handling | PASS | `opponent_disconnected` + lobby return |
| Input sending per frame | PASS | `updateMultiplayer()` in requestAnimationFrame |
| Latency tolerance | PASS | 4 features: interpolation, timestamps, buffers, delta-time |
| **Pointer lock on game start** | **FAIL** | **Called from WebSocket handler, not user gesture** |

The server-side networking is solid and proven correct (verified via live two-player handshake test). The bug is entirely client-side in the lobby-to-gameplay transition.

### Other Dimensions

- **Core Engine (25%)**: Complete — DDA raycasting, 320x200, procedural textures, depth-sorted sprites, collision with wall sliding.
- **Gameplay (25%)**: Complete — All 5 weapons, all 5 enemy types, all 5 levels.
- **AI System (15%)**: Complete — State machine, pathfinding, per-type behaviors, sound alerting.
- **Multiplayer (20%)**: 95% complete — All networking works. The pointer lock bug blocks actual playability.
- **UI/Audio (10%)**: Complete — HUD, menus, lobby, minimap, Web Audio.
- **Code Quality (5%)**: Complete — ES6 modules, no frameworks, no syntax errors.

## Gaps

1. **CRITICAL**: `requestPointerLock()` called from WebSocket handler fails silently in all modern browsers. Game appears frozen on both clients after both players ready up.

2. **Minor**: `player_ready` handler in `setupNetworkHandlers` (line 1046) checks `msg.playerId !== mpState.localPlayerId`, but `localPlayerId` is null at this point. All `player_ready` messages trigger `opponentReady()` including the player's own ready message. Cosmetic — does not break functionality.

3. **Minor**: Lobby `COUNTDOWN` state exists but `startCountdown()` is never called. The game skips directly from `READY_UP` to `MP_PLAYING` via `game_start`. Not a bug but unused code.

## Feedback

### How to Fix the Critical Bug

**Option A (Recommended): Add a "Click to Start" overlay**

After receiving `game_start`, transition to an intermediate state that shows a "CLICK TO START" prompt. When the user clicks, acquire pointer lock from that click handler (trusted gesture), then enter `MP_PLAYING`:

```js
function onMultiplayerGameStart(msg) {
    // ... existing setup code (map, player, weapons, etc.) ...

    syncCamera();
    prevPlayerHealth = player.health;

    // Don't request pointer lock here — it won't work from a WebSocket handler.
    // Instead, show a "click to start" screen.
    gameState = GameState.MP_WAITING_CLICK; // new state
}

// In the game loop, render a "CLICK TO START" overlay on top of the arena.
// On canvas click (user gesture), acquire pointer lock and enter MP_PLAYING.
```

**Option B: Use the existing canvas click handler**

Remove the `requestPointerLock()` call from `onMultiplayerGameStart` and let the existing `input._onCanvasClick` handle it. But add a visible "CLICK TO PLAY" text overlay in `renderMultiplayer` when pointer lock is not active, so players know to click:

```js
// In renderMultiplayer, after all rendering:
if (!input.isPointerLocked()) {
    bufferCtx.font = 'bold 14px "Courier New"';
    bufferCtx.fillStyle = '#FFCC00';
    bufferCtx.textAlign = 'center';
    bufferCtx.fillText('CLICK TO PLAY', SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2);
}
```

### Additional Recommendations

1. **Fix the `player_ready` handler**: Store `localPlayerId` on the `mpState` when receiving `room_created` or `player_joined`, not just in `initMatch`. This allows correct filtering of `player_ready` messages.

2. **Consider adding a countdown**: The `COUNTDOWN` lobby state is already implemented but unused. Wiring it up would give players a 3-2-1-GO visual before gameplay, which also gives time for pointer lock acquisition on the final click.

## Pipeline Execution Notes

1. **User report**: "The multiplayer freezes when both opponents are ready"
2. **Orchestrator**: Identified evaluation gap — tools only do static analysis, no runtime behavior checks
3. **Builder**: Added `mp_pointer_lock_game_start` check to verify-multiplayer.js; added critical check to criteria.yaml; updated run-evaluation.sh to enforce critical failure logic
4. **QA**: Re-ran evaluation — 218/219 pass, 1 critical failure (`mp_pointer_lock_game_start`)
5. **Visionary**: **REJECTED** — Critical multiplayer bug blocks the high-level goal. The server networking is solid but the client-side pointer lock issue makes the game unplayable in multiplayer.

### Root Cause Analysis

The server sends `game_start` to both clients. Both clients process it correctly (verified via live two-player WebSocket test — server sends game_start, starts game loop, broadcasts state updates). The client's `onMultiplayerGameStart` sets up the arena, player, weapons, and camera correctly. It then calls `displayCanvas.requestPointerLock()` which **silently fails** because browsers require a trusted user gesture for pointer lock. Without pointer lock, `InputManager._onMouseMove` exits early (`if (!this._pointerLocked) return`), so all mouse input is lost. Both players see the arena rendered but cannot look around, aim, or shoot.

---
*Detailed per-tool results are in `2026-02-18-114043-results/`.*
