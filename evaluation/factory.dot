// Retro Fury Factory Pipeline — Multiplayer Smoothness
// Developer fixes client-server reconciliation jitter, evaluator verifies
// using browser-based arena tests with Puppeteer frame capture.

digraph retro_fury_factory {
  graph [goal="Fix jittery multiplayer gameplay in the retro-fury FPS game. The local player's camera oscillates visibly because server state corrections (arriving at 20 ticks/sec) are applied with a fixed blend=0.3 and angle is snapped directly. The evaluator's browser-based arena test captured 695 frames showing persistent visual jitter throughout a 137-second match. The developer must smooth the client-server reconciliation so that local player movement appears fluid at 60fps. The evaluator will re-run the Puppeteer arena test and verify frame-to-frame smoothness.", default_max_retry="3"];

  rankdir=LR;
  label="Retro Fury Factory — Smooth Multiplayer";

  node [shape=box, style="rounded,filled", fillcolor=white, timeout="600s", max_agent_turns="20"];

  start [shape=Mdiamond, label="start"];
  exit [shape=Msquare, label="exit"];

  implement [label="Fix MP Jitter", is_codergen="true", llm_model="gpt-5.3-codex", llm_provider="openai", max_retry="3", timeout="600s", llm_prompt="You are a senior game developer fixing multiplayer jitter in the retro-fury FPS game.\n\nWORKSPACE: Work in the retro-fury/ directory. DO NOT modify retro-fury-evaluator/.\n\nBUG DESCRIPTION:\nThe local player's view jitters/oscillates during multiplayer gameplay. The root cause is in src/main.js at the WebSocket 'state' message handler (around line 1073-1098). Every server tick (~50ms), the client reconciles its position:\n\n  const blend = 0.3;\n  player.pos.x += dx * blend;\n  player.pos.y += dy * blend;\n  player.angle = p.angle;  // Hard snap!\n\nThis causes two problems:\n1. POSITION OSCILLATION: Client predicts position forward at 60fps, then every 50ms the server correction yanks it back by 30% of the error. This creates a visible sawtooth jitter pattern.\n2. ANGLE SNAP: player.angle is set directly to the server's angle (no interpolation), causing instant rotation jumps every server tick.\n\nThe remote player (src/game/remote-player.js) already has proper interpolation with LERP_SPEED=15.0. The local player reconciliation should use a similar approach.\n\nRECOMMENDED FIX:\n1. In src/main.js, replace the fixed blend=0.3 with a dt-based exponential smoothing approach. Use a smoothing factor that converges to server position over ~100-200ms rather than jumping 30% each tick.\n2. Interpolate player.angle toward p.angle using shortest-arc lerp instead of snapping.\n3. Consider accumulating server corrections and applying them gradually across frames rather than all at once when the 'state' message arrives.\n4. Ensure the camera (syncCamera) uses the smoothed position, not raw position.\n\nAdditional context:\n- Server sends state at 20 ticks/sec (50ms intervals)\n- Client renders at 60fps (16.7ms frames)\n- Movement speed is 3.0 tiles/sec\n- The snap threshold is distSq > 4 (>2 tiles), which is fine for teleport correction\n- Remote player interpolation in remote-player.js is a good reference\n\nDO NOT change server tick rate or protocol — only fix the client-side reconciliation.\nDO NOT modify eval-server.py or any evaluator files.\n\nAfter fixing: verify no syntax errors (node -c on all changed files), commit and push."];

  qa_verify [shape=diamond, label="QA Verify Fix", max_retry="2", llm_model="gpt-5.3-codex", llm_provider="openai", llm_prompt="You are a QA lead verifying the multiplayer smoothness fix in the retro-fury game.\n\nWORKSPACE: Read files from retro-fury/ (game source code).\n\nVerify ALL of the following:\n1. The fixed blend=0.3 position reconciliation in src/main.js has been replaced with smooth interpolation (dt-based or exponential smoothing)\n2. player.angle is interpolated (lerped) toward server angle, NOT snapped directly\n3. No syntax errors in any modified files (run node -c on each)\n4. The snap threshold for large corrections (distSq > 4) is still preserved for teleport cases\n5. The fix does not break single-player mode (updateMultiplayer is only called in MP)\n6. The camera sync function uses the smoothed position\n\nIf ALL checks pass: outcome success, preferred_next_label QA Passed.\nIf ANY check fails: outcome fail, preferred_next_label QA Failed, list every issue."];

  submit [label="Submit to Evaluator", llm_model="gpt-5.3-codex", llm_provider="openai", auto_status="true", timeout="120s", llm_prompt="Submit the fixed game to the evaluator.\n\nRun: bash retro-fury-evaluator/tools/submit.sh retro-fury/\nThis copies the game snapshot into retro-fury-evaluator/submissions/.\nVerify the submission was created successfully.\nRecord the submission ID."];

  eval_orchestrator [label="Eval Orchestrator", llm_model="gpt-5.3-codex", llm_provider="openai", max_retry="2", llm_prompt="You are the evaluation orchestrator for the retro-fury FPS game.\n\nWORKSPACE: Work in retro-fury-evaluator/ directory.\n\nA new submission has been received after the developer fixed multiplayer jitter. Run the evaluation:\n\n1. Run the full pipeline: bash tools/run-evaluation.sh\n2. Pay special attention to browser-arena results (arena_* checks)\n3. The browser-arena test launches 2 Puppeteer browsers and plays a full match with auto-combat\n4. Check that all 6 arena checks pass, especially arena_no_errors (critical)\n5. Write a structured report to reports/ with pass/fail counts and evidence\n\nKey checks to focus on:\n- arena_browsers_loaded: Both browsers load without errors\n- arena_game_started: Game reaches MP_PLAYING state\n- arena_no_errors: No JS runtime errors during match (CRITICAL)\n- arena_match_outcome: Match completes with victory\n- arena_tier_progression: Gun Game tiers advance\n- All existing mp_* checks still pass"];

  eval_visionary [shape=diamond, label="Eval Visionary", max_retry="2", llm_model="gpt-5.3-codex", llm_provider="openai", allow_partial="true", llm_prompt="You are the visionary for the retro-fury project. Judge the submission.\n\nWORKSPACE: Work in retro-fury-evaluator/ directory.\nVision: evaluation/vision.md\nCriteria: evaluation/criteria.yaml\n\nReview the evaluation report. Focus on multiplayer smoothness:\n1. Did the jitter fix improve client-server reconciliation?\n2. Is angle interpolation smooth (no hard snaps)?\n3. Do all arena_* browser checks pass?\n4. Do all existing checks still pass (no regressions)?\n5. Are there any JS errors during multiplayer?\n\nThe key improvement we're looking for: the position reconciliation now uses smooth interpolation instead of fixed 0.3 blend, and angle is lerped instead of snapped.\n\nScoring: APPROVED >= 80% all critical pass (outcome success), PARTIAL >= 60% (outcome partial_success), REJECTED < 60% or critical fail (outcome fail).\nIf evaluation was insufficient: outcome retry."];

  // Edges
  start -> implement;
  implement -> qa_verify;

  qa_verify -> submit [label="QA Passed", condition="outcome=success", weight="10"];
  qa_verify -> submit [label="QA Passed (partial)", condition="outcome=partial_success", weight="5"];
  qa_verify -> implement [label="QA Failed", condition="outcome=fail", weight="10"];

  submit -> eval_orchestrator;
  eval_orchestrator -> eval_visionary;

  eval_visionary -> exit [label="Approved", condition="outcome=success", weight="10"];
  eval_visionary -> exit [label="Approved (partial)", condition="outcome=partial_success", weight="5"];
  eval_visionary -> eval_orchestrator [label="Refine Evaluation", condition="outcome=retry", weight="10"];
  eval_visionary -> implement [label="Rejected", condition="outcome=fail", weight="10"];
}
