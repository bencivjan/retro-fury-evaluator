// Retro Fury Factory Pipeline — Multiplayer Smoothness
// Developer fixes client-server reconciliation jitter, evaluator verifies
// using browser-based arena tests with Puppeteer frame capture.

digraph retro_fury_factory {
  graph [goal="Fix jittery multiplayer gameplay in the retro-fury FPS game. The local player's camera oscillates visibly because server state corrections (arriving at 20 ticks/sec) are applied with a fixed blend=0.3 and angle is snapped directly. The evaluator's browser-based arena test captured 695 frames showing persistent visual jitter throughout a 137-second match. The developer must smooth the client-server reconciliation so that local player movement appears fluid at 60fps. The evaluator will re-run the Puppeteer arena test and verify frame-to-frame smoothness.", default_max_retry="3"];

  rankdir=LR;
  label="Retro Fury Factory — Smooth Multiplayer";

  node [shape=box, style="rounded,filled", fillcolor=white, timeout="600s", max_agent_turns="20"];

  start [shape=Mdiamond, label="start"];
  exit [shape=Msquare, label="exit"];

  implement [label="Fix MP Jitter", is_codergen="true", llm_model="gpt-5.3-codex", llm_provider="openai", max_retry="3", timeout="600s", llm_prompt="You are a senior game developer fixing multiplayer jitter in the retro-fury FPS game.\n\nWORKSPACE: Work in the retro-fury/ directory. DO NOT modify retro-fury-evaluator/.\n\nPREVIOUS FAILED ATTEMPT:\nA previous developer tried removing player.angle = p.angle entirely. This broke combat because server-side hitscan uses the SERVER angle to aim. Without angle reconciliation, client and server angles drift apart over time. The server fires in the wrong direction and hits never register. DO NOT remove angle reconciliation. You must KEEP it but SMOOTH it.\n\nBUG DESCRIPTION:\nThe local player's view jitters/oscillates during multiplayer gameplay. The root cause is in src/main.js at the WebSocket 'state' message handler. Every server tick (~50ms), the client reconciles its position:\n\n  const blend = 0.3;\n  player.pos.x += dx * blend;\n  player.pos.y += dy * blend;\n  player.angle = p.angle;  // Hard snap!\n\nProblems:\n1. POSITION: Fixed blend=0.3 causes sawtooth jitter (predict forward, then snap back 30%).\n2. ANGLE: Direct snap causes instant rotation jumps every 50ms.\n\nREQUIRED FIX (do exactly this):\n1. Store server correction targets instead of applying them immediately. Add module-level variables:\n   let _serverTargetX = 0, _serverTargetY = 0, _serverTargetAngle = 0, _hasServerTarget = false;\n2. In the 'state' message handler, store the targets instead of blending:\n   _serverTargetX = p.x; _serverTargetY = p.y; _serverTargetAngle = p.angle; _hasServerTarget = true;\n   Keep the distSq > 4 snap for teleport correction.\n3. In updateMultiplayer(), AFTER player.update(dt, mpMap, input), apply smooth corrections:\n   if (_hasServerTarget) {\n     const lerpFactor = Math.min(1.0, 8.0 * dt); // smooth over ~125ms\n     player.pos.x += (_serverTargetX - player.pos.x) * lerpFactor;\n     player.pos.y += (_serverTargetY - player.pos.y) * lerpFactor;\n     // Shortest-arc angle lerp:\n     let aDiff = _serverTargetAngle - player.angle;\n     while (aDiff > Math.PI) aDiff -= 2*Math.PI;\n     while (aDiff < -Math.PI) aDiff += 2*Math.PI;\n     player.angle += aDiff * lerpFactor;\n   }\n4. Keep player.health = p.health and player.alive = p.alive in the state handler.\n\nCRITICAL CONSTRAINTS:\n- You MUST keep angle reconciliation (interpolated, not removed)\n- You MUST keep position reconciliation (smoothed, not removed)\n- DO NOT remove any reconciliation code — only change HOW it is applied\n- The server owns authoritative state; the client must converge to it\n\nAfter fixing: run node -c src/main.js to verify syntax, commit and push."];

  qa_verify [shape=diamond, label="QA Verify Fix", max_retry="2", llm_model="gpt-5.3-codex", llm_provider="openai", llm_prompt="You are a QA lead verifying the multiplayer smoothness fix in the retro-fury game.\n\nWORKSPACE: Read files from retro-fury/ (game source code).\n\nVerify ALL of the following:\n1. Position reconciliation uses smooth dt-based interpolation (NOT fixed blend=0.3)\n2. Angle reconciliation STILL EXISTS but uses interpolated lerp (NOT hard snap AND NOT removed entirely)\n   - FAIL if player.angle = p.angle is still a hard snap\n   - FAIL if angle reconciliation was removed (the server must stay authoritative for aim)\n3. No syntax errors in modified files (run node -c src/main.js)\n4. The snap threshold for large corrections (distSq > 4) is preserved for teleport cases\n5. player.health and player.alive are still reconciled from server state\n6. The fix only modifies the state handler and updateMultiplayer — no other gameplay changes\n\nIf ALL checks pass: outcome success, preferred_next_label QA Passed.\nIf ANY check fails: outcome fail, preferred_next_label QA Failed, list every issue."];

  submit [label="Submit to Evaluator", llm_model="gpt-5.3-codex", llm_provider="openai", auto_status="true", timeout="120s", llm_prompt="Submit the fixed game to the evaluator.\n\nRun: bash retro-fury-evaluator/tools/submit.sh retro-fury/\nThis copies the game snapshot into retro-fury-evaluator/submissions/.\nVerify the submission was created successfully.\nRecord the submission ID."];

  eval_orchestrator [label="Eval Orchestrator", llm_model="gpt-5.3-codex", llm_provider="openai", max_retry="2", llm_prompt="You are the evaluation orchestrator for the retro-fury FPS game.\n\nWORKSPACE: Work in retro-fury-evaluator/ directory.\n\nA new submission has been received after the developer fixed multiplayer jitter. Run the evaluation:\n\n1. Run the full pipeline: bash tools/run-evaluation.sh\n2. Pay special attention to browser-arena results (arena_* checks)\n3. The browser-arena test launches 2 Puppeteer browsers and plays a full match with auto-combat\n4. Check that all 6 arena checks pass, especially arena_no_errors (critical)\n5. Write a structured report to reports/ with pass/fail counts and evidence\n\nKey checks to focus on:\n- arena_browsers_loaded: Both browsers load without errors\n- arena_game_started: Game reaches MP_PLAYING state\n- arena_no_errors: No JS runtime errors during match (CRITICAL)\n- arena_match_outcome: Match completes with victory\n- arena_tier_progression: Gun Game tiers advance\n- All existing mp_* checks still pass"];

  eval_visionary [shape=diamond, label="Eval Visionary", max_retry="2", llm_model="gpt-5.3-codex", llm_provider="openai", allow_partial="true", llm_prompt="You are the visionary for the retro-fury project. Judge the submission.\n\nWORKSPACE: Work in retro-fury-evaluator/ directory.\nVision: evaluation/vision.md\nCriteria: evaluation/criteria.yaml\n\nReview the evaluation report. Focus on multiplayer smoothness:\n1. Did the jitter fix improve client-server reconciliation?\n2. Is angle interpolation smooth (no hard snaps)?\n3. Do all arena_* browser checks pass?\n4. Do all existing checks still pass (no regressions)?\n5. Are there any JS errors during multiplayer?\n\nThe key improvement we're looking for: the position reconciliation now uses smooth interpolation instead of fixed 0.3 blend, and angle is lerped instead of snapped.\n\nScoring: APPROVED >= 80% all critical pass (outcome success), PARTIAL >= 60% (outcome partial_success), REJECTED < 60% or critical fail (outcome fail).\nIf evaluation was insufficient: outcome retry."];

  // Edges
  start -> implement;
  implement -> qa_verify;

  qa_verify -> submit [label="QA Passed", condition="outcome=success", weight="10"];
  qa_verify -> submit [label="QA Passed (partial)", condition="outcome=partial_success", weight="5"];
  qa_verify -> implement [label="QA Failed", condition="outcome=fail", weight="10"];

  submit -> eval_orchestrator;
  eval_orchestrator -> eval_visionary;

  eval_visionary -> exit [label="Approved", condition="outcome=success", weight="10"];
  eval_visionary -> exit [label="Approved (partial)", condition="outcome=partial_success", weight="5"];
  eval_visionary -> eval_orchestrator [label="Refine Evaluation", condition="outcome=retry", weight="10"];
  eval_visionary -> implement [label="Rejected", condition="outcome=fail", weight="10"];
}
