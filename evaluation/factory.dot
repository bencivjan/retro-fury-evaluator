// Retro Fury Factory Pipeline
// Combined developer + evaluator for fixing the pointer lock bug.
// Developer agent fixes code in retro-fury/, evaluator re-evaluates.

digraph retro_fury_factory {
  graph [goal="Fix the critical pointer lock bug in the retro-fury multiplayer game and verify the fix. The bug: requestPointerLock() is called from a WebSocket onmessage handler in onMultiplayerGameStart(), which silently fails because browsers require a trusted user gesture. Mouse input is completely dead after both players ready up, making multiplayer unplayable. The evaluator REJECTED the submission (218/219 checks passed, 1 critical failure). The developer must fix the bug and the evaluator must verify the fix works.", default_max_retry="3"];

  rankdir=LR;
  label="Retro Fury Factory (Developer + Evaluator)";

  node [shape=box, style="rounded,filled", fillcolor=white, timeout="600s", max_agent_turns="15"];

  Start [shape=circle, label="Start"];
  Exit [shape=doublecircle, label="Exit"];

  implement [label="Fix Pointer Lock Bug", is_codergen="true", llm_model="gpt-5.3-codex", llm_provider="openai", max_retry="3", timeout="600s", llm_prompt="You are a senior game developer fixing a critical bug in the retro-fury FPS game.\n\nWORKSPACE: Work in the retro-fury/ directory (the game source code). DO NOT modify files in retro-fury-evaluator/.\n\nCRITICAL BUG (from evaluator report at retro-fury-evaluator/reports/2026-02-18-114043.md):\nIn src/main.js, the function onMultiplayerGameStart() calls displayCanvas.requestPointerLock() from inside a WebSocket onmessage handler. Browsers SILENTLY REJECT requestPointerLock() unless it originates from a trusted user gesture (click, keypress). This means:\n- After both players ready up and game_start is received, the game transitions to MP_PLAYING\n- The arena renders correctly but mouse input is completely dead\n- InputManager._onMouseMove returns early when !this._pointerLocked\n- Players cannot look around, aim, or shoot\n- The game appears FROZEN to both players\n\nRECOMMENDED FIX (Option B from evaluator):\n1. Remove the requestPointerLock() call from onMultiplayerGameStart()\n2. Let the existing canvas click handler (input._onCanvasClick) handle pointer lock acquisition\n3. Add a visible CLICK TO PLAY text overlay in renderMultiplayer() when pointer lock is not active\n4. Also fix: player_ready handler in setupNetworkHandlers checks msg.playerId !== mpState.localPlayerId but localPlayerId is null. Store localPlayerId on mpState when receiving room_created or player_joined.\n\nAfter fixing: verify no syntax errors, commit and push changes, then write status.json confirming the fix."];

  qa_verify [shape=diamond, label="QA Verify Fix", max_retry="2", llm_model="gpt-5.3-codex", llm_provider="openai", llm_prompt="You are a QA lead verifying the pointer lock bug fix in the retro-fury game.\n\nWORKSPACE: Read files from retro-fury/ (the game source code).\n\nVerify ALL of the following:\n1. The requestPointerLock() call has been REMOVED from onMultiplayerGameStart() in src/main.js\n2. There is a visible CLICK TO PLAY overlay rendered when pointer lock is not active during multiplayer\n3. The existing canvas click handler still acquires pointer lock on user click\n4. The player_ready handler correctly filters self-messages using localPlayerId\n5. No syntax errors in any modified files\n6. The fix does not break single-player mode\n\nIf ALL checks pass: outcome success, preferred_next_label QA Passed.\nIf ANY check fails: outcome fail, preferred_next_label QA Failed, list every issue."];

  submit [label="Submit to Evaluator", llm_model="gpt-5.3-codex", llm_provider="openai", auto_status="true", timeout="120s", llm_prompt="Handle submission handoff from developer to evaluator.\n\nRun: bash retro-fury-evaluator/tools/submit.sh retro-fury/\nThis copies the game snapshot into retro-fury-evaluator/submissions/.\nVerify the submission was created successfully.\nRecord the submission ID in status.json context_updates."];

  eval_orchestrator [label="Eval Orchestrator", llm_model="gpt-5.3-codex", llm_provider="openai", max_retry="2", llm_prompt="You are the evaluation orchestrator for the retro-fury FPS game.\n\nWORKSPACE: Work in retro-fury-evaluator/ directory.\n\nA new submission has been received after the developer fixed the critical pointer lock bug. The previous evaluation (reports/2026-02-18-114043.md) found 218/219 checks passed with 1 CRITICAL FAILURE: mp_pointer_lock_game_start.\n\nRun the full evaluation pipeline: bash retro-fury-evaluator/tools/run-evaluation.sh\nCapture results for all 219 checks.\nPay special attention to mp_pointer_lock_game_start.\nWrite a structured report to retro-fury-evaluator/reports/ with pass/fail counts and evidence.\nInclude the submission ID, score, and verdict in status.json."];

  eval_visionary [shape=diamond, label="Eval Visionary", max_retry="2", llm_model="gpt-5.3-codex", llm_provider="openai", allow_partial="true", llm_prompt="You are the visionary for the retro-fury project.\n\nWORKSPACE: Work in retro-fury-evaluator/ directory.\nVision: retro-fury-evaluator/evaluation/vision.md\nCriteria: retro-fury-evaluator/evaluation/criteria.yaml\n\nReview the evaluation report. Judge the submission:\n1. Did the pointer lock bug get fixed?\n2. Is there a visible CLICK TO PLAY prompt for multiplayer?\n3. Do all 219 checks pass including mp_pointer_lock_game_start?\n4. Are there any regressions?\n\nScoring: APPROVED >= 80% all critical pass (outcome success), PARTIAL >= 60% (outcome partial_success), REJECTED < 60% or critical fail (outcome fail).\nIf evaluation was insufficient: outcome retry.\nWrite the final report to retro-fury-evaluator/reports/."];

  // Edges
  Start -> implement;
  implement -> qa_verify;

  qa_verify -> submit [label="QA Passed", condition="outcome=success", weight="10"];
  qa_verify -> submit [label="QA Passed (partial)", condition="outcome=partial_success", weight="5"];
  qa_verify -> implement [label="QA Failed", condition="outcome=fail", weight="10"];

  submit -> eval_orchestrator;
  eval_orchestrator -> eval_visionary;

  eval_visionary -> Exit [label="Approved", condition="outcome=success", weight="10"];
  eval_visionary -> Exit [label="Approved (partial)", condition="outcome=partial_success", weight="5"];
  eval_visionary -> eval_orchestrator [label="Refine Evaluation", condition="outcome=retry", weight="10"];
  eval_visionary -> implement [label="Rejected", condition="outcome=fail", weight="10"];
}
